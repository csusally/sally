---
date: "2018-03-19"
title: "强制缓存和协议缓存"
category: "构建"
tags: ["构建", "webpack","前端工程化"]
banner: ""
---

前端工程师都知道网页加载性能可以通过对一些资源文件进行合理缓存达到优化加载速度的目的。浏览器对静态资源的缓存本质上是http协议的缓存策略，可以分为**强制缓存**和**协议缓存**。

强制缓存策略通过过期时间决定使用户本地缓存还是请求新的资源；协商缓存每次都会发出请求，经过服务器对比后决定使用本地缓存还是新资源。缓存策略的执行通过http协议的headers信息决定。

1、  Expires 和 max-age
Expires 和 max-age是强制缓存策略的关键信息，两者均是相应首部信息的。expires是http1.0加入的特性，表明缓存资源的特定过期时间。expires可以在缓存期内减少客户端http请求，不仅节省了客户端处理时间和提高了web应用的执行速度，同时减少了网络资源消耗，如：

**expires: Mon, 18 Mar 2019 09:52:46 GMT**
不过expires的时间是以服务器时间为准，而客户端进行过期判断是以客户端时间为准，因此如果两者之间存在误差，则可能缓存资源就会失效，就会发起网络请求。

为了解决这个问题，http1.1 新增了cache-control首部信息（**cache-control:private, max-age=86400, stale-while-revalidate=604800**）便于更精确的控制缓存，常用的cache-control信息有：

*  on-cache & on-store
      on-cache: 并非禁止缓存，需要先和服务器确认返回相应是否有变，未变则使用缓存副本
      on-store：表示禁止缓存，每次均要向服务器请求
  
* public & private
      public： 表示此相应浏览器和中间缓存器无限期使用，此信息不常用，使用max-age制定精确缓存时间
      private：表示此相应可以被用户浏览器缓存，但是不允许任何中间缓存器缓存。如用户浏览器可以缓存包含用户私人信息的html页面，cdn则不行。
  

* **max-age**

  表示从请求时刻开始，相应的缓存副本有效的最长时间，单位是秒。不会受到客户端和服务端时间不一致的影响，比expires优先级更高。
  
2 Etag和if-none-match

etag是服务器为资源分配的字符串形式的唯一标识，作为相应头部信息返回浏览器。浏览器在缓存过期或者禁止缓存的情况下，etag会通过if-none-match作为请求头部发送给服务器。服务器在接收请求之后会判断请求资源的etag是否改变，未改变则返回304，然后根据既定的缓存策略分配cache-control信息；若改变则返回资源的同时重新分配etag值。

需要强制使用协商缓存策略，需要将cache-control的首部信息设置为no-cache。这样实现每次均需要从服务器进行对比。协商缓存适用于非服务器渲染的html页面文件，由于html文件会引用其他的静态资源以及保证网址的唯一性，因此不能应用hash指纹的同时还被保证每次获取到的文件都是最新的。

